<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>element</title>
    <link rel="stylesheet" href="UI/style.css">
</head>
<body>

<div class="top-navbar" style="z-index: 10;">
  <center>
    <input placeholder="Поиск" id="searcher">
    <button><img></button>
  </center>
</div>

<br>
<div style="margin-top: 56px;"></div>

<div id="comments" class="CommentsClosed" style="width: 500px;position: fixed; left: 50px; height: 510px; background-color: rgb(25, 25, 25);overflow: auto; transition: 0.3s;">
  <center>
    <button onclick="document.querySelector('#comments').className = 'CommentsClosed'; document.querySelector('.posts').style.filter = 'none';" style="width: 400px; height: 4px;background-color: rgb(90, 25, 25);cursor: pointer;"></button>
    <input id="commentInput" style="border-top-right-radius: 0;border-bottom-right-radius: 0; height: 40px;width: 390px;" placeholder="Введите текст">
    <button onclick="eel.send_comment(postId, document.querySelector('#commentInput').value)(function() {loadComms(); document.querySelector('#commentInput').value = ''})" style="cursor: pointer;border-top-left-radius: 0;border-bottom-left-radius: 0;width: 60px;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizontal"><path d="M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z"/><path d="M6 12h16"/></svg></button>
    <hr>
    <div></div>
  </center>
</div>

<div id="musicPlayer" style="display: none; top: 130px;left: 60px;height: 70px;width: 500px;z-index: 10;position: fixed;background-color: rgb(25, 25, 25);border-radius: 10px;">
  <audio></audio>
  <div style="display: flex; align-items: center; gap: 10px; border-radius: 5px;">
    <img src="noMusicCover.jpg" style="width: 50px; height: 50px; border-radius: 5px;margin-top: 10px;margin-left: 10px;margin-bottom: 12px;">
    <div style="display: flex; flex-direction: column; flex-grow: 1;">
      <p style="margin: 0; font-size: 16px;">Название - Автор</p>
      <input type="range" style="width: 95%; margin-top: 10px;height: 4px;" value="0" onchange="document.querySelector('audio').currentTime = this.value">
    </div>
  </div>
</div>

<div id="music" class="musicClosed" style="width: 500px;position: fixed; left: 50px; height: 600px; background-color: rgb(25, 25, 25);overflow: none;overflow-y: scroll; transition: 0.3s;">
  <center>
    <button onclick="document.querySelector('#music').className = 'musicClosed';document.querySelector('#musicPlayer').style.display = 'none'; document.querySelector('.posts').style.filter = 'none';" style="width: 400px; height: 4px;background-color: rgb(90, 25, 25);cursor: pointer;"></button>
    <h2 style="margin-left: 25px; text-align: left;">Любимые</h2>
    <div id="favorite" style="display: inline-flex;overflow-x: auto;overflow-y: none;width: 500px;"></div>
    <h2 style="margin-left: 25px; text-align: left;">Новые</h2>
    <div id="new" style="display: inline-flex;overflow-x: scroll;overflow-y: none;width: 500px;"></div>
    <h2 style="margin-left: 25px; text-align: left;">Случайные</h2>
    <div id="random" style="display: inline-flex;overflow-x: scroll;overflow-y: none;width: 500px;"></div>
  </center>
</div>

<div id="searcherDIV" class="searchClosed" style="width: 500px; height: 210px; position: fixed; left: 50px; background-color: rgb(25, 25, 25); overflow: auto; transition: 0.3s;">
  <center>
    <!--<button onclick="document.querySelector('#comments').className = 'CommentsClosed'" style="width: 400px; height: 4px;background-color: rgb(90, 25, 25);cursor: pointer;"></button>-->
    <div></div>
  </center>
</div>

<div class="posts" style="overflow-x: none;">
  <div class="Post">
    <textarea maxlength="3400" style="height: 56px; width: 587px;" placeholder="Введите текст"></textarea>
    <div>
      <button onclick="eel.new_post(document.querySelector('textarea').value)(function() {window.location.reload()})" class="UI-Button comments">Отправить</button>
    </div>
  </div>
</div>

<script src="/eel.js"></script>
<script>
var postId = 0 

function loadComms() { 
  eel.load_comments(postId)(function(comments) {
    document.querySelector("#comments").querySelector("div").innerHTML = ''
    for (let i = 0; i < comments.length; i++) {
      document.querySelector("#comments").querySelector("div").innerHTML += `
      <div class="Post1">
        <div style="margin-bottom: 10px;display: flex;">
          <img src="https://elemsocial.com/Content/Avatars/${comments[i].Avatar}" alt="avatar">
          <div style="display: flex;flex-direction: column;margin: 0;">
            <a style="color: white; text-decoration: none;margin: 0;" href="/profiles.html?username=${comments[i].Username}">${comments[i].Name}</a>
            <p>${TimeAgo(comments[i].Date)}</p>
          </div>
        </div>
        ${comments[i].Text}
      </div>`
    }
  })
}

function TimeAgo(dateStr) {
  const date = new Date(dateStr.replace(" ", "T"));
  if (isNaN(date.getTime())) return "Некорректная дата"; // Проверка на корректность

  const now = new Date();
  const diffInSeconds = Math.floor((now - date) / 1000);

  if (diffInSeconds < 60) return "только что";
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} минут назад`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} часов назад`;
  if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} дней назад`;
  if (diffInSeconds < 31536000) return `${Math.floor(diffInSeconds / 2592000)} месяцев назад`;

  return `${Math.floor(diffInSeconds / 31536000)} лет назад`;
}

function substr12(text) {
  if (text.length > 12) {
    return text.substring(0, 10) + "...";
  }
  return text
}

function substr78(text) {
  if (text.length > 78) {
    return text.substring(0, 75) + "...";
  }
  return text
}

function load_music() {
  // var indexF = document.querySelectorAll('#music').querySelector('#favorite').length
  // var indexN = document.querySelectorAll('#music').querySelector('#new').length
  // var indexR = document.querySelectorAll('#music').querySelector('#random').length
  var index = 0
  document.querySelector('#music').querySelector('#favorite').innerHTML = ""
  document.querySelector('#music').querySelector('#random').innerHTML = ""
  document.querySelector('#music').querySelector('#new').innerHTML = ""
  eel.get_music("FAVORITES", index)(function(music) {
    for (let i = 0; i < music.length; i++) {
      var cover = "noMusicCover.jpg";
      if (music[i].Cover) {
        cover = "https://elemsocial.com/Content/Simple/" + music[i].Cover.simple_image
      }
      document.querySelector('#music').querySelector('#favorite').innerHTML += `
      <div class="MusicItem" id="${music[i].ID}">
        <img src="${cover}"><br>
        ${substr12(music[i].Title)}<br>
        <p style="font-size: 12px;font-family: 'SF Pro Display Bold', Arial, Helvetica, sans-serif;color: rgb(150, 150, 150);">${substr12(music[i].Artist)}</p>
      </div>`
    }
  })
  eel.get_music("LATEST", index)(function(music) {
    for (let i = 0; i < music.length; i++) {
      var cover = "noMusicCover.jpg";
      if (music[i].Cover) {
        cover = "https://elemsocial.com/Content/Simple/" + music[i].Cover.simple_image
      }
      document.querySelector('#music').querySelector('#new').innerHTML += `
      <div class="MusicItem" id="${music[i].ID}">
        <img src="${cover}"><br>
        ${substr12(music[i].Title)}<br>
        <p style="font-size: 12px;font-family: 'SF Pro Display Bold', Arial, Helvetica, sans-serif;color: rgb(150, 150, 150);">${substr12(music[i].Artist)}</p>
      </div>`
    }
  })
  eel.get_music("RANDOM", index)(function(music) {
    for (let i = 0; i < music.length; i++) {
      var cover = "noMusicCover.jpg";
      if (music[i].Cover) {
        cover = "https://elemsocial.com/Content/Simple/" + music[i].Cover.simple_image
      }
      document.querySelector('#music').querySelector('#random').innerHTML += `
      <div class="MusicItem" id="${music[i].ID}">
        <img src="${cover}"><br>
        ${substr12(music[i].Title)}<br>
        <p style="font-size: 12px;font-family: 'SF Pro Display Bold', Arial, Helvetica, sans-serif;color: rgb(150, 150, 150);">${substr12(music[i].Artist)}</p>
      </div>`
    }
  })
  setTimeout(function() {
    document.querySelectorAll(".MusicItem").forEach(item => {
      item.addEventListener("click", function() {
        eel.load_song(item.id)(function(song){
          document.querySelector("audio").src = "https://elemsocial.com/Content/Music/Files/" + song.File
          var player = document.querySelector("#musicPlayer")
          player.querySelector("p").innerHTML = substr78(song.Title + " - " + song.Artist)
          if (song.Cover) {
            player.querySelector("img").src = "https://elemsocial.com/Content/Simple/" + song.Cover.simple_image
          } else {
            player.querySelector("img").src = "noMusicCover.jpg"
          }
          document.querySelector("audio").addEventListener("loadedmetadata", function () {
            player.querySelector("input").max = document.querySelector("audio").duration
            document.querySelector("audio").play()
          })

          document.querySelector("audio").addEventListener("timeupdate", function () {
            player.querySelector("input").value = document.querySelector("audio").currentTime
          })
        })
      })
    });
  }, 1000)
}

function load_posts() {
var index = document.querySelectorAll('.Post').length - 1
eel.load_posts(index)(function(posts) {
  posts = JSON.parse(posts);
  console.log(posts)

  for (let i = 0; i < posts.length; i++) {
    if (posts[i].Comments == 0) {
      var comments = "Обсуждения"
    } else {
      var comments = posts[i].Comments
    }
    if (posts[i].Dislikes == 0) {
      var dislikes = "Дизлайк"
    } else {
      var dislikes = posts[i].Dislikes
    }
    if (posts[i].Likes == 0) {
      var likes = "Лайк"
    } else {
      var likes = posts[i].Likes
    }

    var liked = "like"
    var disliked = "like"

    if (posts[i].Liked) {
      liked = "liked"
    }
    if (posts[i].Disliked) {
      disliked = "liked"
    }
    
    var postContent = ""

    if (posts[i].Content) {
      if (JSON.parse(posts[i].Content).Image) {
        postContent = `<img src="https://elemsocial.com/Content/Posts/Images/${JSON.parse(posts[i].Content).Image.file_name}" alt="Photo" style="margin-top: 19px;width: ${JSON.parse(posts[i].Content).Image.width}px; max-width: 600px;height: ${JSON.parse(posts[i].Content).Image.height}px; max-height: 900px; border-radius: 10px;">`
      }
    }

    document.querySelector(".posts").innerHTML += `
<div class="Post">
  <div style="margin-bottom: 10px;display: flex;">
    <img src="https://elemsocial.com/Content/Avatars/${posts[i].Avatar}" alt="avatar">
    <div style="display: flex;flex-direction: column;margin: 0;">
      <a style="color: white; text-decoration: none;margin: 0;" href="/profiles.html?id=${posts[i].AuthorID}">${posts[i].Name}</a>
      <p style="font-size: 12px;color: rgb(200, 200, 200);">${TimeAgo(posts[i].Date)}</p>
    </div>
  </div>
  ${posts[i].Text}<br>
  ${postContent}
  <div>
        <button onclick="if (this.className == 'like') {eel.actionOnPost(${posts[i].ID}, 'LIKE')(); this.className = 'liked'} else {eel.actionOnPost(${posts[i].ID}, 'DELETE')(); this.className = 'like'}" class="UI-Button ${liked}" style="font-size: 16; margin-rigth: 0; border-top-right-radius: 0px; border-bottom-right-radius: 0px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg> ${likes}</button>
        <button onclick="eel.actionOnPost(${posts[i].ID}, 'DISLIKE')(); this.className = 'disliked' class="UI-Button ${disliked}" style="font-size: 16; margin-left: 0;margin-right: 0; border-radius: 0px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart-off"><line x1="2" y1="2" x2="22" y2="22"/><path d="M16.5 16.5 12 21l-7-7c-1.5-1.45-3-3.2-3-5.5a5.5 5.5 0 0 1 2.14-4.35"/><path d="M8.76 3.1c1.15.22 2.13.78 3.24 1.9 1.5-1.5 2.74-2 4.5-2A5.5 5.5 0 0 1 22 8.5c0 2.12-1.3 3.78-2.67 5.17"/></svg> ${dislikes}</button>
        <button onclick="postId = ${posts[i].ID}; loadComms();document.querySelector('.posts').style.filter = 'blur(10px)'; document.querySelector('#comments').className = 'Comments';" class="UI-Button comments" style="font-size: 16; margin-left: 0; border-top-left-radius: 0px; border-bottom-left-radius: 0px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M8 10h.01"/><path d="M12 10h.01"/><path d="M16 10h.01"/></svg> ${comments}</button>
  </div>
</div>`;
  }
});
}

load_posts()

window.addEventListener("load", function() {
  eel.my_profile()(function(profile) {
    document.querySelector('.top-navbar').querySelector('button').querySelector('img').src = `https://elemsocial.com/Content/Avatars/${JSON.parse(profile).Avatar}`
  })
  
  window.addEventListener("scroll", () => {
    if (window.scrollY + window.innerHeight >= document.documentElement.scrollHeight - 1) {
      load_posts()
    }
  })

  document.querySelector('#searcher').addEventListener("input", function() {
    document.querySelector('#searcherDIV').className = 'search'
    if(document.querySelector('#searcher').value == "") {
      document.querySelector('#searcherDIV').className = 'searchClosed'
    }

    eel.search(document.querySelector('#searcher').value, "Users")(function(results) {
      document.querySelector('#searcherDIV').querySelector('div').innerHTML = ''
      for (let i = 0; i < results.Content.length; i++) {
        document.querySelector('#searcherDIV').querySelector('div').innerHTML += `
        
    <div class="Post1">
      <img src="https://elemsocial.com/Content/Avatars/${results.Content[i].Avatar}" alt="avatar">
      <div style="display: flex;flex-direction: column;margin: 0;">
        <a style="color: white; text-decoration: none;margin: 0;" href="/profiles.html?Username=${results.Content[i].Username}">${results.Content[i].Name}</a>
        ${results.Content[i].Subs} подписчиков • ${results.Content[i].Posts} постов
      </div>
    </div>`
      }
    })
  })
})

</script>
<div style="margin-bottom: 74px;"></div>
<div class="down-navbar">
  <div style="margin-bottom: 15px;"></div>
  <center>
    <button onclick="window.location.href = '/home.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-house"><path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"/><path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      <br>
      Главная
    </button>
    <button onclick="window.location.href = '/home.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
      <br>
      Месенджер
    </button>
    <button onclick="load_music(); document.querySelector('.posts').style.filter = 'blur(10px)'; document.querySelector('#music').className = 'music';document.querySelector('#musicPlayer').style.display = 'block';">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-music"><path d="M21 15V6"/><path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/><path d="M12 12H3"/><path d="M16 6H3"/><path d="M12 18H3"/></svg>
      <br>
      Музыка
    </button>
    <button onclick="window.location.href = '/home.html'">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      <br>
      Настройки
    </button>
  </center>
</div>
</body>
</html>